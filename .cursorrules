## Project: Windows Ctrl+Alt+Del GNOME Shell Extension

This workspace contains a GNOME Shell extension (`extension.js`) that implements a Windows-style Ctrl+Alt+Del screen.
All automated assistance (including AI) should follow these rules unless the user explicitly overrides them.

---

### 1. Imports and general GJS style

- **Imports only at the top of the file**
  - Do not introduce new `imports.*` or `const X = imports...` statements anywhere except at the very top of `extension.js`.
  - Reuse existing imports where possible instead of adding duplicates (e.g. `Meta`, `ExtensionUtils` are already imported).

- **No global monkey‑patching**
  - Do not add or re‑add any polyfills / prototype patches like `Clutter.Actor.prototype.get_visible`.
  - If you absolutely must patch core objects, it must be paired with a robust revert in `disable()` and justified in comments, but prefer avoiding this altogether.

---

### 2. Spawning processes and subprocess rules

- **Never use synchronous spawn**
  - Do **not** use `GLib.spawn_command_line_sync()` or any other synchronous spawn in `extension.js` or new files.
  - If you need to run an external command, use `Gio.Subprocess` with `communicate_utf8_async()` as shown in the GJS Subprocess guide:
    - `https://gjs.guide/guides/gio/subprocesses.html#complete-examples`

- **Prefer not to spawn external commands when a D-Bus or library API exists**
  - Before adding a new spawn, check whether the action can be done via D-Bus or an existing GNOME API; if yes, prefer that.

---

### 3. D-Bus usage requirements

- **Use D-Bus instead of shell commands for core desktop actions**
  - Locking, logout, suspend, poweroff, reboot, and switching user **must** use D-Bus APIs rather than calling CLIs like `dbus-send`, `systemctl`, `gnome-session-quit`, or `gdmflexiserver`.
  - Follow patterns compatible with the GJS D-Bus guide:
    - `https://gjs.guide/guides/gio/dbus.html`
  - Examples already in this project (do **not** regress them):
    - Lock via `org.gnome.ScreenSaver.Lock` on the session bus if `Main.screenShield.lock()` is unavailable.
    - Logout via `org.gnome.SessionManager.Logout(uint32 mode)` (mode `1` = no prompt).
    - Power actions via `org.freedesktop.login1.Manager.Suspend/PowerOff/Reboot(false)` on the system bus.
    - Switch user via `org.gnome.DisplayManager.Seat.SwitchToGreeter` on `/org/gnome/DisplayManager/Seat0`.

---

### 4. Timeouts and main-loop sources

- **Always track and remove `GLib.timeout_add` sources**
  - Every `GLib.timeout_add()` must store its source ID in a variable (e.g. `_sizeUpdateId`, `_positionUpdateId`, `_lockResetId`, `_toggleStateTimeoutId`, `_focusMonitorId`, `_pollingId`).
  - Before creating a new timeout for the same purpose, remove any existing source with `GLib.source_remove(id)` and set the id to `null`.
  - In `CtrlAltDelDialog.close()` and `CtrlAltDelDialog.destroy()`, ensure all dialog-owned timeouts are removed.
  - In `disable()`, ensure all global timeouts and polling sources are removed (`_pollingId`, `_lockResetId`, `_toggleStateTimeoutId`, etc.).
  - Follow the EGO review guideline: remove main-loop sources on destroy/disable:
    - `https://gjs.guide/extensions/review-guidelines/review-guidelines.html#remove-main-loop-sources`

---

### 5. Settings and schemas

- **Use `ExtensionUtils.getSettings()`**
  - Always obtain the GSettings object via `ExtensionUtils.getSettings('org.gnome.shell.extensions.ctrl-alt-del')`.
  - Do not reintroduce `new Gio.Settings({ schema_id: ... })` for this extension schema.

- **Schema file requirements**
  - The schema file is `schemas/org.gnome.shell.extensions.ctrl-alt-del.gschema.xml`.
  - Any changes that add keys or change settings behaviour must be reflected in this schema file.
  - Keep the `ctrl-alt-del` key as an array-of-strings accelerator key for the global keybinding.

---

### 6. GNOME Shell versions and metadata

- **No bogus shell versions like "42.9"**
  - Do not add non-existent or “fake” shell version strings (e.g. `"42.9"`) anywhere (including `metadata.json` or comments that might be copied).
  - Only use real, supported versions (current `metadata.json` uses `"42"`, `"43"`, `"44"`; update responsibly if needed).

---

### 7. Error handling (`try` / `catch`)

- **Avoid blanket `try/catch` unless needed**
  - Do not wrap large blocks of code in `try { ... } catch (e) {}` without specific handling.
  - Use `try/catch` narrowly, only around calls that are expected to fail (D-Bus calls, geometry queries, etc.), and log meaningful messages when catching.
  - If you add any new `try/catch`, include a brief comment explaining **why** failure is expected and how it should be handled.

---

### 8. `open()` and layout complexity

- **Do not over-engineer `open()` further**
  - The existing `CtrlAltDelDialog.open()` is already complex and likely AI-generated; avoid adding further layers of polling or geometry tricks unless strictly necessary.
  - Prefer simplification (fewer timeouts, less duplicated logic) over adding new complexity, but only when the user explicitly asks for refactoring.
  - Any substantial change to `open()` must keep:
    - Correct multi-monitor behaviour.
    - Stable button layout.
    - Proper cleanup of all timeouts and signals.

---

### 9. Testing expectations

- **Do not provide large behavioural changes without a testing plan**
  - When making non-trivial changes (especially in `open()`, D-Bus calls, or timeouts), describe how they should be tested in a real GNOME Shell session.
  - If you cannot run GNOME Shell in this environment, clearly state that runtime testing is required on the user’s machine before relying on the change.

---

### 10. AI-generated code awareness

- **Be conservative when touching obviously AI-generated sections**
  - Parts of `extension.js` (especially the large `open()` implementation and its comments) appear to be AI-generated.
  - Treat them carefully: prefer targeted fixes to satisfy guidelines rather than full rewrites unless the user explicitly requests a redesign.
  - When in doubt, ask for user confirmation before major refactors of these sections.


